---
config:
      theme: redux
---
flowchart TD
    %% ==========================================
    %% Styling
    %% ==========================================
    classDef actor fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef agent fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    classDef process fill:#fff3e0,stroke:#e65100,stroke-width:2px;
    classDef data fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,stroke-dasharray: 5 5;
    classDef decision fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef guardrail fill:#ffebee,stroke:#c62828,stroke-width:2px;

    %% ==========================================
    %% Runtime Entry + Main Loop (main.py)
    %% ==========================================
    subgraph Runtime[Runtime: main.py]
        User((User)):::actor
        Init["Process start / env setup"]:::process
        GetBusinessState["get_real_business_state()"]:::process
        SessionDB[("SQLite sessions table\n(DatabaseSessionService)")]:::data
        BusinessDB[("Business DB\nProducts/Themes/Epics/Features/Stories/Sprints/etc")]:::data
        RunnerInit["Runner(agent=root_agent)"]:::process
        InputLoop["while True: get_user_input()"]:::process
        ExitCheck{"user_input in [exit, quit]?"}:::decision
        RunTurn["run_agent_turn()"]:::process
        ZdrRetry{"OpenRouter privacy routing error?"}:::decision
        Backoff["Retry w/ backoff (ZDR_MAX_RETRIES)"]:::process
        SysTriggerLoop["evaluate_workflow_triggers() loop"]:::process
        TriggerDecision{"system_instruction?"}:::decision
        RunSysTurn["run_agent_turn(is_system_trigger=True)"]:::process
        End["Exit program"]:::process

        User --> InputLoop
        Init --> GetBusinessState --> BusinessDB
        GetBusinessState --> SessionDB
        SessionDB --> RunnerInit
        RunnerInit --> InputLoop
        InputLoop --> ExitCheck
        ExitCheck -->|Yes| End
        ExitCheck -->|No| RunTurn
        RunTurn --> ZdrRetry
        ZdrRetry -->|Yes| Backoff --> RunTurn
        ZdrRetry -->|No| SysTriggerLoop
        SysTriggerLoop --> TriggerDecision
        TriggerDecision -->|Yes| RunSysTurn --> SysTriggerLoop
        TriggerDecision -->|No| InputLoop
    end

    %% ==========================================
    %% run_agent_turn() internals (main.py)
    %% ==========================================
    subgraph RunTurnDetails["run_agent_turn internals"]
        BuildPrompt["Build prompt w/ prior_vision_state\n(from sessions table)"]:::process
        CallRunner["runner.run_async(...)"]:::process
        ToolEvents["Capture tool calls/responses + text"]:::process
        ExtractData["data_to_save = tool response OR extract_json_from_response"]:::process
        PersistDecision{"PERSIST_LLM_OUTPUT == 1?"}:::decision
        UpdateState["update_state_in_db()\n(vision_components / roadmap_draft / sprint_plan)"]:::process
        StateDB[("SQLite sessions state")]:::data

        BuildPrompt --> CallRunner --> ToolEvents --> ExtractData --> PersistDecision
        PersistDecision -->|Yes| UpdateState --> StateDB
        PersistDecision -->|No| StateDB
    end

    RunTurn --> BuildPrompt
    RunSysTurn --> BuildPrompt
    SessionDB -.-> BuildPrompt
    StateDB -.-> SessionDB

    %% ==========================================
    %% Orchestrator Agent (root_agent)
    %% ==========================================
    subgraph Orchestrator[Orchestrator Agent: orchestrator_agent/agent.py]
        RootAgent["root_agent (Agent)\nmodel=LiteLlm"]:::agent
        Instruction["instructions.txt\n(state machine + routing)"]:::data
        InputSchema["InputSchema"]:::data
        ModeConfig["story_pipeline_mode config\n(appended to instructions)"]:::data

        RootAgent --> Instruction
        RootAgent --> InputSchema
        RootAgent --> ModeConfig
    end

    CallRunner --> RootAgent

    %% ==========================================
    %% Orchestrator Instruction-Driven State Machine (instructions.txt)
    %% ==========================================
    subgraph StateMachine["Instruction-defined states"]
        S1["STATE 1: Interview Mode\n(product_vision_tool)"]:::process
        S2["STATE 2: Vision Review\n(wait for save confirmation)"]:::process
        S3["STATE 3: Save Vision\n(save_vision_tool)"]:::process
        S4["STATE 4: Routing Mode\n(project selection / new project / list)"]:::process
        S5["STATE 5: Roadmap Interview\n(product_roadmap_tool)"]:::process
        S6["STATE 6: Roadmap Review"]:::process
        S7["STATE 7: Save Roadmap\n(save_roadmap_tool)"]:::process
        S8["STATE 8: Story Setup\n(query_features_for_stories)"]:::process
        S9["STATE 9: Story Pipeline\n(process_single_story per feature)"]:::process
        S10["STATE 10: Save Stories\n(save_validated_stories)"]:::process
        S11["STATE 11: Sprint Setup\n(get_backlog_for_planning)"]:::process
        S12["STATE 12: Sprint Draft\n(plan_sprint_tool)"]:::process
        S13["STATE 13: Save Sprint\n(save_sprint_tool)"]:::process
        S14["STATE 14: Sprint View\n(get_sprint_details)"]:::process
        S15["STATE 15: Sprint List\n(list_sprints)"]:::process
        S16["STATE 16: Update Story Status\n(update_story_status / batch_update_story_status)"]:::process
        S17["STATE 17: Modify Sprint Stories\n(modify_sprint_stories)"]:::process
        S18["STATE 18: Complete Sprint\n(complete_sprint)"]:::process
        S19["STATE 19: Complete Story w/ Notes\n(complete_story_with_notes)"]:::process
        S20a["STATE 20: View Story Details\n(get_story_details)"]:::process
        S20b["STATE 20: Spec Compile Mode\n(compile_spec_authority_for_version)"]:::process
        S21["STATE 21: Spec Update Mode\n(update_spec_and_compile_authority)"]:::process
        AmbigNote["NOTE: STATE 20 defined twice\n(ambiguous id in instructions)"]:::guardrail

        S20a -.-> AmbigNote
        S20b -.-> AmbigNote
    end

    RootAgent --> StateMachine

    %% ==========================================
    %% Agent Tools: Vision + Roadmap (sub-agents)
    %% ==========================================
    subgraph VisionRoadmapAgents[AgentTool sub-agents]
        VisionAgent["product_vision_tool (Agent)\nInputSchema -> OutputSchema"]:::agent
        RoadmapAgent["product_roadmap_tool (Agent)\nInputSchema -> OutputSchema"]:::agent
    end

    S1 --> VisionAgent
    S2 --> VisionAgent
    S3 --> SaveVisionTool
    S5 --> RoadmapAgent
    S6 --> RoadmapAgent
    S7 --> SaveRoadmapTool

    %% ==========================================
    %% Direct Tools (root_agent tools list)
    %% ==========================================
    subgraph Tools[Direct tools called by root_agent]
        CountProjects["count_projects"]:::process
        ListProjects["list_projects"]:::process
        GetProjectDetails["get_project_details"]:::process
        GetProjectByName["get_project_by_name"]:::process
        SelectProject["select_project"]:::process
        LoadSpecFile["load_specification_from_file"]:::process

        SaveSpec["save_project_specification"]:::process
        ReadSpec["read_project_specification"]:::process
        CompileSpecVersion["compile_spec_authority_for_version"]:::process
        UpdateSpecAndCompile["update_spec_and_compile_authority"]:::process
        EnsureAcceptedAuthority["ensure_accepted_spec_authority"]:::process

        QueryFeatures["query_features_for_stories"]:::process
        GetStoryDetails["get_story_details"]:::process

        SaveVisionTool["save_vision_tool"]:::process
        SaveRoadmapTool["save_roadmap_tool"]:::process

        ProcessSingleStory["process_single_story"]:::process
        SaveValidatedStories["save_validated_stories"]:::process

        GetBacklog["get_backlog_for_planning"]:::process
        PlanSprint["plan_sprint_tool"]:::process
        SaveSprint["save_sprint_tool"]:::process
        GetSprintDetails["get_sprint_details"]:::process
        ListSprints["list_sprints"]:::process

        UpdateStoryStatus["update_story_status"]:::process
        BatchUpdateStoryStatus["batch_update_story_status"]:::process
        ModifySprintStories["modify_sprint_stories"]:::process
        CompleteSprint["complete_sprint"]:::process
        CompleteStoryNotes["complete_story_with_notes"]:::process
        UpdateAC["update_acceptance_criteria"]:::process
        CreateFollowUp["create_follow_up_story"]:::process
    end

    S4 --> CountProjects
    S4 --> ListProjects
    S4 --> GetProjectDetails
    S4 --> GetProjectByName
    S4 --> SelectProject
    S4 --> LoadSpecFile

    S4 --> SaveSpec
    S4 --> ReadSpec

    S8 --> QueryFeatures
    S9 --> ProcessSingleStory
    S10 --> SaveValidatedStories
    S20a --> GetStoryDetails

    S11 --> GetBacklog
    S12 --> PlanSprint
    S13 --> SaveSprint
    S14 --> GetSprintDetails
    S15 --> ListSprints

    S16 --> UpdateStoryStatus
    S16 --> BatchUpdateStoryStatus
    S17 --> ModifySprintStories
    S18 --> CompleteSprint
    S19 --> CompleteStoryNotes
    S19 --> UpdateAC
    S19 --> CreateFollowUp

    S20b --> CompileSpecVersion
    S21 --> UpdateSpecAndCompile

    %% ==========================================
    %% Data / DB effects for direct tools
    %% ==========================================
    CountProjects --> BusinessDB
    ListProjects --> BusinessDB
    GetProjectDetails --> BusinessDB
    GetProjectByName --> BusinessDB
    SelectProject --> BusinessDB

    LoadSpecFile --> SpecFiles[("Spec files on disk")]:::data
    LoadSpecFile --> SessionDB

    SaveSpec --> BusinessDB
    SaveSpec --> SpecFiles
    ReadSpec --> BusinessDB

    SaveVisionTool --> BusinessDB
    SaveRoadmapTool --> BusinessDB

    QueryFeatures --> BusinessDB
    GetStoryDetails --> BusinessDB

    GetBacklog --> BusinessDB
    PlanSprint --> BusinessDB
    SaveSprint --> BusinessDB
    GetSprintDetails --> BusinessDB
    ListSprints --> BusinessDB
    UpdateStoryStatus --> BusinessDB
    BatchUpdateStoryStatus --> BusinessDB
    ModifySprintStories --> BusinessDB
    CompleteSprint --> BusinessDB
    CompleteStoryNotes --> BusinessDB
    UpdateAC --> BusinessDB
    CreateFollowUp --> BusinessDB

    %% ==========================================
    %% Story Pipeline (process_single_story)
    %% ==========================================
    subgraph StoryPipeline[Story Pipeline: process_single_story]
        PSInput["ProcessStoryInput"]:::data
        Defaults["normalize_story_input_defaults"]:::process
        ResolveSpec["resolve_spec_version_id"]:::process
        AuthorityGate["ensure_accepted_spec_authority\n(if spec_version_id missing)"]:::guardrail
        AuthoritySetup["setup_authority_and_alignment"]:::process
        AlignCheck{"feature aligned to forbidden capabilities?"}:::decision
        RejectFeature["Return rejection response"]:::guardrail
        InitState["build_initial_state"]:::process

        RunnerSetup["create_pipeline_runner"]:::process
        BranchRefiner{"enable_story_refiner?"}:::decision
        BranchSpecValidator{"enable_spec_validator?"}:::decision

        LoopAgent["ConditionalLoopAgent\nmax_iterations=4\nexit when refinement_result.is_valid"]:::process
        SeqPipeline["SequentialAgent\nStoryDraft -> SpecValidator -> StoryRefiner"]:::process

        SeqNoSpec["SequentialAgent\nStoryDraft -> StoryRefiner"]:::process
        DraftOnly["SelfHealingAgent(StoryDraftAgent)"]:::process

        Execute["execute_pipeline()\nRunner.run_async"]:::process
        PostProcess["process_pipeline_result"]:::process
        Result["Return story + validation outcome"]:::data

        PSInput --> Defaults --> ResolveSpec --> AuthorityGate --> AuthoritySetup
        AuthoritySetup --> AlignCheck
        AlignCheck -->|No| RejectFeature
        AlignCheck -->|Yes| InitState --> RunnerSetup --> BranchRefiner
        BranchRefiner -->|Yes| BranchSpecValidator
        BranchSpecValidator -->|Yes| LoopAgent
        LoopAgent --> SeqPipeline
        BranchSpecValidator -->|No| SeqNoSpec
        BranchRefiner -->|No| DraftOnly

        SeqPipeline --> Execute
        SeqNoSpec --> Execute
        DraftOnly --> Execute
        Execute --> PostProcess --> Result
    end

    ProcessSingleStory --> StoryPipeline

    %% ==========================================
    %% Story Pipeline Sub-Agents
    %% ==========================================
    subgraph StoryPipelineAgents[Story pipeline sub-agents]
        StoryDraftAgent["StoryDraftAgent (LlmAgent)\ninput=StoryDraftInput\noutput=StoryDraft"]:::agent
        SpecValidatorAgent["SpecValidatorAgent (LlmAgent)\noutput=SpecValidationResult"]:::agent
        StoryRefinerAgent["StoryRefinerAgent (LlmAgent)\ninput=StoryRefinerInput\noutput=RefinementResult"]:::agent
        SelfHeal["SelfHealingAgent\n(retry on ValidationError or ZDR)"]:::guardrail
    end

    SeqPipeline --> StoryDraftAgent
    SeqPipeline --> SpecValidatorAgent
    SeqPipeline --> StoryRefinerAgent
    SeqPipeline -.-> SelfHeal
    SeqNoSpec --> StoryDraftAgent
    SeqNoSpec --> StoryRefinerAgent
    DraftOnly --> StoryDraftAgent

    %% ==========================================
    %% Alignment + Negation Checking (deterministic)
    %% ==========================================
    subgraph Alignment[Deterministic alignment checks]
        ExtractInvariants["extract_invariants_from_authority"]:::process
        DeriveForbidden["derive_forbidden_capabilities_from_authority"]:::process
        FeatureCheck["validate_feature_alignment"]:::process
        StoryCheck["check_alignment_violation + detect_requirement_drift"]:::process
        NegationTolerance{"model_config.get_story_pipeline_negation_tolerance()?"}:::decision
        NegationAgent["NegationCheckerAgent (LlmAgent)"]:::agent
    end

    AuthoritySetup --> ExtractInvariants --> DeriveForbidden --> FeatureCheck
    PostProcess --> StoryCheck --> NegationTolerance
    NegationTolerance -->|Yes| NegationAgent --> StoryCheck

    %% ==========================================
    %% Story Save (save_validated_stories)
    %% ==========================================
    subgraph SaveStories[save_validated_stories]
        PendingState["pending_validated_stories\n(from tool_context.state)"]:::data
        SaveLoop["Persist each story -> UserStory"]:::process
        ValidateAfterSave["validate_story_with_spec_authority"]:::process
        ValidationEvidence["Persist validation_evidence\naccepted_spec_version_id on pass"]:::data

        PendingState --> SaveLoop --> ValidateAfterSave --> ValidationEvidence
    end

    SaveValidatedStories --> SaveStories
    SaveStories --> BusinessDB

    %% ==========================================
    %% Spec Authority Compiler Pipeline (spec_tools)
    %% ==========================================
    subgraph SpecAuthority[Spec Authority Compilation]
        UpdateSpec["update_spec_and_compile_authority"]:::process
        CompileSpec["compile_spec_authority_for_version"]:::process
        InvokeCompiler["_invoke_spec_authority_compiler\n(spec_authority_compiler_agent)"]:::process
        Normalize["normalize_compiler_output"]:::process
        SaveAuthority["Persist CompiledSpecAuthority"]:::process
        EnsureAccepted["ensure_spec_authority_accepted (auto)"]:::process
        AuthorityDB[("SpecRegistry + CompiledSpecAuthority\nSpecAuthorityAcceptance")]:::data
        CompilerAgent["spec_authority_compiler_agent (Agent)"]:::agent

        UpdateSpec --> CompileSpec --> InvokeCompiler --> CompilerAgent
        InvokeCompiler --> Normalize --> SaveAuthority --> AuthorityDB
        UpdateSpec --> EnsureAccepted --> AuthorityDB
    end

    CompileSpecVersion --> SpecAuthority
    UpdateSpecAndCompile --> SpecAuthority
    AuthorityGate --> SpecAuthority

    %% ==========================================
    %% Sprint Planning Tool Internals (high-level)
    %% ==========================================
    subgraph SprintPlanningTools[Sprint planning tools]
        DraftPlan["plan_sprint_tool\n- validate stories TO_DO\n- create/find Team\n- compute capacity"]:::process
        SaveSprintInternal["save_sprint_tool\n- idempotent save\n- emit WorkflowEvent"]:::process
        BacklogQuery["get_backlog_for_planning"]:::process
        SprintQuery["get_sprint_details / list_sprints"]:::process
        SprintExec["update_story_status / batch_update / modify_sprint_stories / complete_sprint"]:::process
    end

    PlanSprint --> DraftPlan
    SaveSprint --> SaveSprintInternal
    GetBacklog --> BacklogQuery
    GetSprintDetails --> SprintQuery
    ListSprints --> SprintQuery
    UpdateStoryStatus --> SprintExec
    BatchUpdateStoryStatus --> SprintExec
    ModifySprintStories --> SprintExec
    CompleteSprint --> SprintExec

    %% ==========================================
    %% High-level data flows
    %% ==========================================
    VisionAgent --> SaveVisionTool
    RoadmapAgent --> SaveRoadmapTool
    SaveRoadmapTool --> BusinessDB
    ProcessSingleStory --> BusinessDB
    SaveValidatedStories --> BusinessDB
    PlanSprint --> BusinessDB
    SaveSprint --> BusinessDB

    %% ==========================================
    %% System Triggers (evaluate_workflow_triggers)
    %% ==========================================
    subgraph SystemTriggers["System triggers"]
        HasBacklog{"state.product_backlog exists?"}:::decision
        HasSprintPlan{"state.sprint_plan exists?"}:::decision
        PlanConfirmed{"state.sprint_plan_confirmed?"}:::decision
        DevTasksActive{"state.dev_tasks_active?"}:::decision
        TriggerBacklog["[SYSTEM TRIGGER]\nProduct Backlog updated"]:::process
        TriggerPlan["[SYSTEM TRIGGER]\nSprint Plan confirmed"]:::process

        HasBacklog --> HasSprintPlan
        HasSprintPlan -->|No| TriggerBacklog
        PlanConfirmed --> DevTasksActive
        DevTasksActive -->|No| TriggerPlan
    end

    SessionDB -.-> HasBacklog
    SessionDB -.-> PlanConfirmed
    TriggerBacklog --> RunSysTurn
    TriggerPlan --> RunSysTurn