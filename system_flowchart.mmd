---
config:
      theme: redux
---
graph TD
    %% Global Styles
    classDef input fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:black;
    classDef agent fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px,color:black;
    classDef artifact fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,color:black;
    classDef db fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,stroke-dasharray: 5 5,color:black;
    classDef book fill:#ffffff,stroke:#333,stroke-width:1px,stroke-dasharray: 2 2,font-style:italic,color:#666;

    Start((Start)) --> UserInput[User Idea]:::input
    Start --> SpecInput[Spec File/Docs]:::input

    %% PHASE 0: SPEC AUTHORITY (SHIFT LEFT)
    subgraph Phase0 [Pre-Phase: Authority Compilation]
        direction TB
        SpecAgent(<b>Agent: preview_spec_authority</b><br/>Stateless Compiler):::agent
        SpecArtifact(<b>Artifact: Compiled Authority</b><br/>JSON Rules & Constraints):::artifact
    end

    SpecInput --> SpecAgent
    SpecAgent --> SpecArtifact

    %% PHASE 1: PRODUCT VISION
    subgraph Phase1 [Phase 1: Product Vision]
        direction TB
        VisionAgent(<b>Agent: product_vision_tool</b><br/>Generates 'Mad Libs' Statement):::agent
        VisionArtifact(<b>Artifact: Product Vision</b><br/>'For... Who... The... Is a...'):::artifact

        RefP35[Ref: Chapter 2, Page 35<br/>'The First Steps']:::book
    end

    UserInput --> VisionAgent
    SpecArtifact --> VisionAgent
    VisionAgent --> VisionArtifact

    %% PHASE 2 PREP: BACKLOG PRIMER
    subgraph Phase2Prep [Phase 2 Prep: Initial Backlog]
        direction TB
        BacklogAgent(<b>Agent: backlog_primer</b><br/>Value Architect):::agent
        BacklogAction1[Decompose to Requirements<br/><i>Page 50</i>]
        BacklogAction2[Prioritize via ROI/Sat<br/><i>Page 50</i>]
        BacklogAction3[Est. Effort T-Shirts<br/><i>Page 52</i>]
        BacklogArtifact(<b>Artifact: High-Level Backlog</b><br/>List of 'BacklogItem' Objects):::artifact
    end

    VisionArtifact --> BacklogAgent
    SpecArtifact -.-> BacklogAgent
    VisionAgent -.-> BacklogAgent
    BacklogAgent --> BacklogAction1 --> BacklogAction2 --> BacklogAction3 --> BacklogArtifact

    %% PHASE 2: ROADMAP BUILDER
    subgraph Phase2 [Phase 2: Product Roadmap]
        direction TB
        RoadmapAgent(<b>Agent: roadmap_builder</b><br/>Roadmap Builder):::agent
        RoadmapAction1[Identify Dependencies<br/><i>Page 47</i>]
        RoadmapAction2[Group into Themes<br/><i>Page 58</i>]
        RoadmapAction3[Slot into Time Frames<br/><i>Page 48</i>]
        RoadmapArtifact(<b>Artifact: Product Roadmap</b><br/>List of 'RoadmapRelease' Objects):::artifact
        RoadmapDB[(<b>Tool: save_roadmap_tool</b><br/>Persist to DB)]:::db
    end

    BacklogArtifact --> RoadmapAgent
    UserInput -.-> RoadmapAgent
    SpecArtifact -.-> RoadmapAgent
    RoadmapAgent --> RoadmapAction1 --> RoadmapAction2 --> RoadmapAction3 --> RoadmapArtifact
    RoadmapArtifact --> RoadmapDB

    %% CHAPTER 5: USER STORY WRITER
    subgraph Chapter5 [Chapter 5: User Stories]
        direction TB
        StoryAgent(<b>Agent: user_story_writer_tool</b><br/>Story Writer):::agent
        StoryAction1[Vertical Slicing<br/><i>Page 70</i>]
        StoryAction2[INVEST Validation<br/><i>Page 73</i>]
        StoryAction3[Acceptance Criteria<br/><i>Page 77</i>]
        StoryArtifact(<b>Artifact: User Stories</b><br/>JSON List of 'UserStoryItem'):::artifact
        StoryDB[(<b>Tool: save_stories_tool</b><br/>Persist to DB)]:::db
    end

    RoadmapDB --> StoryAgent
    UserInput -.-> StoryAgent
    SpecArtifact -.-> StoryAgent
    StoryAgent --> StoryAction1 --> StoryAction2 --> StoryAction3 --> StoryArtifact
    StoryArtifact --> StoryDB

    %% PHASE 3: SPRINT PLANNING
    subgraph Phase3 [Phase 3: Sprint Planning]
        direction TB
        SprintPlannerAgent(<b>Agent: sprint_planner_tool</b><br/>Sprint Planner):::agent
        SprintPlanAction1[Define Sprint Goal]
        SprintPlanAction2[Capacity Reasoning]
        SprintPlanAction3[Task Decomposition]
        SprintPlanArtifact(<b>Artifact: Sprint Plan</b><br/>JSON 'SprintPlannerOutput'):::artifact
        SprintPlanDB[(<b>Tool: save_sprint_plan_tool</b><br/>Persist to DB)]:::db
    end

    StoryDB --> SprintPlannerAgent
    UserInput -.-> SprintPlannerAgent
    SpecArtifact -.-> SprintPlannerAgent
    SprintPlannerAgent --> SprintPlanAction1 --> SprintPlanAction2 --> SprintPlanAction3 --> SprintPlanArtifact
    SprintPlanArtifact --> SprintPlanDB

    %% Final State
    End((Sprint<br/>Ready)):::input
    SprintPlanDB --> End

    %% Linkages explaining the flow
    RefP47[Gate: Page 47<br/>'Need Backlog to build Roadmap']:::book
    BacklogArtifact -.-> RefP47 -.-> RoadmapAgent